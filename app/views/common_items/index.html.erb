<% @title = @group.name %>
<% @page_action = link_to("Add new item", new_group_common_item_path(:group_id => @group.id)) %>

<div id="group_show">
  <%= render :partial => "groups/group_details" %>
  <div style="overflow-x: scroll">
    <span style="float:left;"><%= page_entries_info(@common_items,  :entry_name => 'items') %></span>
    <span style="float:right;"><%= will_paginate @common_items %></span>
    <br>
    <table id="common_items_table" border="1" rules="all">
      <tr>
        <td><b>Item Name</b></td>
        <td><b>Item Cost(paid by)</b></td>
        <% @users.each do |user| %>
          <td><b><%= user.name.humanize %>'s share</b></td>
        <% end %>
        <td><b>Date</b></td>
      </tr>
      <tr>
        <% form_for([:group, @new_common_item]) do |f| %>
          <%= hidden_field_tag :index, true %>
          <td><%= f.text_field :name, :size => 20 %></td>
          <td><%= f.text_field :cost, :size => 5, :style => "border-color: white;" %></td>
          <% @users.each do |user| %>
            <td><%= text_field :item_cost, user.id, :size => 5, :onkeyup => "update_cost()", :onblur => "update_cost()", :onclick => "update_cost()", :onkeydown => "update_cost()" %></td>
          <% end %>
          <td><%= f.submit "Create", :onclick => "return update_final_cost()" %></td>
        <% end %>
      </tr>
      <% @common_items.each do |common_item| %>
        <tr>
          <td><%= common_item.name.humanize %>&nbsp;&nbsp;<small><%= show_delete_link(common_item)%></small></td>
          <td style="color:red;">Rs.<%= common_item.cost %>(<%= common_item.user.name %>)</td>
          <% @users.each do |user| %>
            <td><%= display_amount(user, common_item) %></td>
          <% end %>
          <td><small><%= common_item.created_at.strftime('%b, %d %Y') %></small></td>
        </tr>
      <% end %>
      <tr style="color:#000099;font-weight:bold;">
        <td>Total Amounts Spent</td>
        <td>Rs.<%= @total_cost %></td>
        <% @users.each do |user| %>
          <td>Rs.<%= @group.get_group_user(user).items.collect(&:default_amount).sum %></td>
        <% end %>
        <td><small><%= Time.now.strftime('%B, %d %Y') %></small></td>
      </tr>
    </table>
    <span style="float:right;"><%= will_paginate @common_items %></span>
  </div>
</div>

<style>
  input[type="text"]{
    border-color: green;
  }

  input[type="submit"]{
    background-image:url(/images/icon-add.gif);
    background-repeat: no-repeat;
    background-color: #336633;
    padding: 0px 1px 0px 22px;
    border-color: #336633;
    color: white;
    font-size: 14px;
    font-weight: bold;
    -moz-border-radius-topleft: 10px;
    -moz-border-radius-topright: 10px;
    -moz-border-radius-bottomleft: 10px;
    -moz-border-radius-bottomright: 10px;
  }
</style>


<script>
  $('common_item_cost').value = 0;
  $('common_item_cost').disabled = true;
  elements = [];

<% @users.each_with_index do |u, i| %>
    elements[<%= i %>] = $('item_cost_<%= u.id %>')
<% end %>

  function update_cost(){
    $('common_item_cost').disabled = false;
    $('common_item_cost').value = 0;
    var sum = 0;
    for(i =0 ; i < elements.length; i++){
      sum += parseInt(elements[i].value || 0);
    }
    $('common_item_cost').value = sum
    $('common_item_cost').disabled = true;
  }

  function update_final_cost(){
    update_cost();
    if($('common_item_name').value == ""){
      alert("Forgot the name?? Give the name of the item");
      return false;
    }
    if(isNaN($('common_item_cost').value)){
      alert("Give valid values for the items");
      return false;
    }
    $('common_item_cost').disabled = false;
  }
</script>